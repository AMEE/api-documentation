<?xml version="1.0"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN" 
  "http://www.docbook.org/xml/5.0/dtd/docbook.dtd"
[
<!ENTITY % translations   SYSTEM "translations.xml">
%translations;
]>

<chapter xmlns:xi="http://www.w3.org/2001/XInclude" xml:id='profiles'>
  <title>Store Data</title>
  <section xml:id='store-data'>
    <title>Using AMEE to store data</title>
    <para>
      If you have a lot of energy information, or want to keep your own application as light
      as possible, you can use AMEE to store your calculations permanently so that you can
      retrieve them later. By handing the database handling requirements to AMEE, you save money 
      on hosting and processing your own data.
    </para>
    <para>
      The process for doing this is very similar to doing calculations as described
      in the previous chapter, except that you use slightly different URLs.
	  The calculation is stored as a Profile Item, which is contained within a Profile.
    </para>
  </section>
  <section xml:id='create-profile'>
    <title>Creating a Profile</title>
    <para>
      In order to store data in AMEE, you need to create one or more profiles. If you are storing 
      data for many different entities, you can use multiple profiles to separate that data into silos.
    </para>
    <para>
      A common use case is to have a separate profile for each user of a web application, but equally you could 
      have a profile for each office in a business application, or any number of other things. In general, the 
      smallest entity in your system will probably correspond to a profile. You should store the Profile UID generated
      by AMEE in your application alongside other data for the entity; there is no way to search AMEE for profiles that 
      match particular metadata, as all profiles are fully anonymised.
    </para>
    <para>
		You create a profile by doing a POST to /profiles, including profile=true in the request body.
	</para>
	<xi:include href='samples/post_3_profiles_profile=true.xml'/>
		<para>
		  We need the UID of the profile in order to create profile items - it becomes part of the path in the next step. As described 
		  in in the Quick Start chapter, for now we'll just grab this out of the response with an XPath expression, <emphasis>//Profile/@uid</emphasis>.
		  For this response, that gives us a UID of YLLIKH73BDYS.
	  </para>
  </section>
  <section xml:id='create-profile'>
    <title>Storing data</title>
    <para>
      Storing data in a profile is pretty much the same as doing one-off calculations as described in the previous section, except that
	  you POST to the category path inside the profile you are using, and provide the model and input parameters in the POST body.
    </para>
    <para>
	  The following example performs the same calculation as in the previous section, but stores it into a profile for later retrieval.
    </para>
	<xi:include href='samples/post_3_profiles_UID_items_category=DEFRA_transport_fuel_methodology_fuel=petrol_values.volume=500_name=example_startDate=2011-01-05T00:00:00Z.xml'/>
	<xi:include href='samples/get_3_profiles_UID_items_UID;amounts.xml'/>
    <para>
      There are a few things to note here, particularly the parameters in the 
      POST request. The first is <emphasis>category</emphasis> and <emphasis>fuel</emphasis> which together specify exactly which model you wish to 
      use for the calculation (in this case, a particular type of fuel). This is the same as we've done for getting data and for one-off calculations,
      so that should make sense already.
    </para>
    <para>
      Secondly we have the <emphasis>volume</emphasis> parameter, which is a parameter specific 
      to this category. As each category can store a different type of data, the profile item values 
      are different for each one. &discover; lists which ones are valid for which categories, as well
      as showing different usage options; which parameters are required, optional, and so on. In this case, 
      the call will send a value of 500 for this item (which is in litres by default - again, see &discover;).
    </para>
    <para>
      Finally we pass the <emphasis>representation=full</emphasis> parameter. This asks &api_name; to
      send back a representation of the calculation. We will see why this is necessary in the next chapter, 
      so don't worry about it for now.
    </para>
  </section>

  <section xml:id='naming-items'>
    <title>Naming Profile Items</title>
    <para>
      If you create two profile items with the same data item UID, and which overlap the same 
      time, then &api_name; will complain, as it can't form a single consistent time series from the 
      data (see below). However, there are cases in which you might want to do this; energy used by two 
      cars of the same type. In this case, you can provide a name parameter to identify each set. 
      You can build up multiple datasets in the same profile category 
      by using different names for each one. A name is not required, but if you suspect that 
      you will want to store multiple datasets alongside each other, it is good practise 
      to specify one.
    </para>
  </section>
  <section xml:id='build-time-series'>
    <title>Building Time Series</title>
    <para>
      Storing a single profile item is useful, but most data changes over time, particularly 
      when we are talking about energy use. &api_name; allows you to store time information along 
      with your data, so that you can build up a series of data points over time.
    </para>
    <para>
      Three parameters are available to control time information, startDate, endDate, and 
      duration. By providing these when you create profile items, you can set the time 
      that the created profile item is valid for. By default, startDate is "now" and 
      endDate is infinitely far in the future. If your data is not time-sensitive, then 
      this will be fine. However, if your data represents usage at a particular time, you 
      can set the values explicitly. The maximum time resolution of &api_name; is 1 
      minute. If seconds are specified, they are rounded down. Note that you can't set 
      endDate and duration at the same time.
    </para>
    <para>
      All these parameters are specified in standard ISO-8601 format. For instance, the 
      following would all be valid parameters (when correctly form-encoded):
    </para>
    <programlisting>startDate=2009-08-01T14:30:55Z
endDate=2009-08-02T14:30:55-08:00
duration=PT30S</programlisting>
  </section>
  <section xml:id='retrieve-items'>
    <title>Retrieving stored data</title>
    <para>
      To retrieve stored data, you can do a GET on the category in which you have created profiles items.
      This will return a paged response listing all the profile items in that category, as well as a total amount
      of emissions for all of them. The request is shown below; see <xref linkend='list-profile-items-reference'/>
      for the full response details.
    </para>
    <para>
      These responses can be filtered by time period; see below.
    </para>
    <para>
      &api_name; does not support aggregation across different categories or profiles. Often the same data
      could be stored in multiple places using different methodologies, so in order to avoid double counting, 
      the aggregation is left to the client who best understands the business logic involved.
    </para>
  </section>
  <section xml:id='time-series-queries'>
    <title>Time Series Queries</title>
    <para>
      Once you have built up a time series, you will probably want to retrieve historical 
      data. Above, we saw that profile categories include a list of current profile items. 
      This "present time" behaviour can be modified by providing startDate and endDate query 
      parameters in the GET request, using the same format as above. 
    </para>
    <para>
      There are a couple of request parameters that control what is returned:
    </para>
    <section>
      <title>selectby</title>
      <table class='properties'>
        <tr><th>Option</th><th>Meaning</th></tr>
        <tr>
          <td><emphasis>unspecified</emphasis></td>
          <td>Include items which intersects the query window.</td>
        </tr>
        <tr>
          <td>start</td>
          <td>Only include items which start during the query window.</td>
        </tr>
        <tr>
          <td>end</td>
          <td>Only include items which end during the query window.</td>
        </tr>
      </table>
    </section>
    <section>
      <title>mode</title>
      <table class='properties'>
        <tr><th>Option</th><th>Meaning</th></tr>
        <tr>
          <td><emphasis>unspecified</emphasis></td>
          <td>
            Get the total emission values for all items.
          </td>
        </tr>
        <tr>
          <td>prorata</td>
          <td>Get only the emissions which took place during the query window.</td>
        </tr>
      </table>
      <para>
        For instance, if you have a profile item that lasts a week, and request just one day within that period, if you 
        do not specify mode, you will still get the emissions for the week. If you specify mode=prorata, you will get the 
        emissions just during that single day.
      </para>
    </section>
  </section>
</chapter>